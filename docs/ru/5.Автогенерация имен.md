
# 5. Автоматическая генерация имён (AutoNaming)

`TheMakarik.Testing.FileSystem` предоставляет удобный механизм автоматической генерации имён файлов и директорий. Это особенно полезно, когда нужно быстро создать большое количество тестовых элементов без ручного придумывания уникальных имён и без риска коллизий.

Автогенерация работает через **предопределённые стратегии** (`NameGenerationType`) или **пользовательскую функцию**. После установки генератора вы можете использовать специальные методы расширения вида `WithNameGeneraing`, которые сами вызывают текущий генератор имён.

## Перечисление NameGenerationType

```csharp
public enum NameGenerationType
{
    RandomName,
    RandomNameAndCount,
    RandomNameAndExtensionCount,
    RandomNumber,
    ExtensionAndCount,
    ExtensionAndExtensionCount,
}
```

### Подробное описание каждой стратегии

| Стратегия                        | Пример результата (расширение .txt)              | Использует случайность?          | Учитывает seed? | Когда использовать                                                                 |
|----------------------------------|---------------------------------------------------|----------------------------------|------------------|------------------------------------------------------------------------------------|
| `RandomName`                     | `abcde.txt`, `xyzkm.txt`, `p9qrs.txt`             | Да (Path.GetRandomFileName)      | **Нет**          | Высокая уникальность, имена не должны быть предсказуемыми                          |
| `RandomNameAndCount`             | `abcde.txt`, `xyzkm(1).txt`, `p9qrs(2).txt`       | Да (Path.GetRandomFileName)      | **Нет**          | Случайность + видимый порядок создания элементов                                   |
| `RandomNameAndExtensionCount`    | `random1.txt`, `random2.txt`, `random3.txt`       | Да (Path.GetRandomFileName)      | **Нет**          | Нужно показывать реальное количество файлов с данным расширением                  |
| `RandomNumber`                   | `-2147483647.txt`, `1480365284.txt`               | Да (Random)                      | **Да**           | Максимальная уникальность, требуется воспроизводимость (с seed)                    |
| `ExtensionAndCount`              | `.txt`, `.txt(1)`, `.txt(2)`, …                   | Нет                              | **Нет**          | Простая последовательная нумерация без случайности                                 |
| `ExtensionAndExtensionCount`     | `.txt`, `.txt(1)`, `.txt(2)`, …                   | Нет                              | **Нет**          | Нумерация по реальному количеству файлов с расширением (без случайности)          |

**Важно про seed:**

- Параметр `seed` (в методе `AddNameGenerator(…, int? seed = null)`) **учитывается ТОЛЬКО** в стратегии `RandomNumber`.
- В этой стратегии происходит:

  ```csharp
  var random = info.RandomSeed is null ? new Random() : new Random(info.RandomSeed.Value);
  return random.Next(int.MinValue, int.MaxValue).ToString();
  ```

- Во всех остальных стратегиях значение `seed` сохраняется в `NamingInfo.RandomSeed`, но **нигде не используется**.
- `RandomName*` используют `Path.GetRandomFileName()` — это внутренний крипто-рандом, не зависящий от `Random` и seed.

## Установка генератора имён

### 1. Предопределённая стратегия

```csharp
.AddNameGenerator(NameGenerationType generationType, int? seed = null)
```

**Пример:**
```csharp
.AddNameGenerator(NameGenerationType.RandomNameAndCount)
.AddFilesWithNameGenerating(".json", 50)
```

### 2. Кастомный генератор

```csharp
.AddCustomNameGenerator(Func<NamingInfo, string> function, int? seed = null)
```

**Пример:**
```csharp
.AddCustomNameGenerator(info => $"test-{Guid.NewGuid():N}{info.Extension}")
```

### 3. Сброс состояния генератора

```csharp
.RefreshNameGenerator()
```

Сбрасывает счётчики и список содержимого. Полезно перед новой логической группой файлов.

**Пример:**
```csharp
.AddFilesWithNameGenerating(".csv", 10)
.RefreshNameGenerator()
.AddFilesWithNameGenerating(".log", 5)   // нумерация начнётся заново
```

## Методы добавления с автогенерацией имён

### Файлы

- `AddFileWithNameGenerating(string extension, string? content = null)`
- `AddFileWithNameGenerating(string extension, out string fullPath, string? content = null)`
- `AddFilesWithNameGenerating(string extension, int count, string? content = null)`
- `AddFilesWithNameGenerating(string extension, out string[] fullPaths, int count, string? content = null)`

### Директории

- `AddDirectoryWithNameGenerating(Func<string, IFileSystemBuilder, IFileSystemBuilder> createDirectoryContent)`
- `AddDirectoryWithNameGenerating(out string path, Func<string, IFileSystemBuilder, IFileSystemBuilder> createDirectoryContent)`
- `AddDirectoriesWithNameGenerating(int count, Func<string, IFileSystemBuilder, IFileSystemBuilder> createDirectoryContent)`
- `AddDirectoriesWithNameGenerating(int count, out string[] paths, Func<string, IFileSystemBuilder, IFileSystemBuilder> createDirectoryContent)`

**Для директорий** расширение считается пустым → большинство стратегий будут добавлять счётчик к пустой строке (т.е. просто `""`, `"(1)"`, `"(2)"` и т.д.).

### Архивы (ZIP и tar)

Для архивов действуют те же принципы автонейминга, что и для файлов:

- для ZIP-архивов (`TheMakarik.Testing.FileSystem.Zip`):
  - `AddZipWithNameGenerating(...)`
  - `AddZipWithNameGenerating(out string archiveFullPath, ...)`
  - `AddZipsWithNameGenerating(int count, ...)`
  - `AddZipsWithNameGenerating(int count, out string[] archiveFullPaths, ...)`
  - а также удобные алиасы:
    - `AddZipWithAutoNaming(...)`
    - `AddZipWithAutoNaming(out string archiveFullPath, ...)`
    - `AddZipsWithAutoNaming(int count, ...)`
    - `AddZipsWithAutoNaming(int count, out string[] archiveFullPaths, ...)`

- для tar-архивов (`TheMakarik.Testing.FileSystem.SharpCompress.Tar`):
  - `AddTarWithNameGenerating(...)`
  - `AddTarWithNameGenerating(out string fullPath, ...)`
  - `AddTarsWithNameGenerating(int count, ...)`
  - `AddTarsWithNameGenerating(int count, out string[] fullPaths, ...)`
  - и соответствующие алиасы:
    - `AddTarWithAutoNaming(...)`
    - `AddTarWithAutoNaming(out string fullPath, ...)`
    - `AddTarsWithAutoNaming(int count, ...)`
    - `AddTarsWithAutoNaming(int count, out string[] fullPaths, ...)`

Во всех этих методах генератор сам устанавливает корректное расширение:

- для ZIP — `.zip`;
- для tar — в зависимости от `TarPackTo`: `.tar`, `.tar.gz` или `.tar.bz2`.

## Полные примеры

### Пример 1 — Нагрузочный тест с большим количеством файлов

```csharp
_fileSystem = FileSystem.BeginBuilding()
    .AddRandomInTempRootName()
    .AddNameGenerator(NameGenerationType.RandomNameAndCount)
    .AddFilesWithNameGenerating(".txt", 200, "Test line\n")
    .RefreshNameGenerator()
    .AddFilesWithNameGenerating(".json", 50, "{}")
    .Build();

_fileSystem.Should()
    .TotalFileCount(250);
```

### Пример 2 — Воспроизводимые имена (только RandomNumber + seed)

```csharp
_fileSystem = FileSystem.BeginBuilding()
    .AddRandomInTempRootName()
    .AddNameGenerator(NameGenerationType.RandomNumber, seed: 20260207)
    .AddFilesWithNameGenerating(".db", 30)
    .Build();
```

При каждом запуске теста имена будут одинаковыми.

### Пример 3 — Простая последовательная нумерация

```csharp
_fileSystem = FileSystem.BeginBuilding()
    .AddRandomInTempRootName()
    .AddNameGenerator(NameGenerationType.ExtensionAndCount)
    .AddFilesWithNameGeneraing(".pdf", 8)
    .AddDirectoryWithNameGenerating((path, b) => b
        .RefreshNameGenerator()
        .AddFilesWithNameGeneraing(".log", 4))
    .Build();
```

Результат (примерно):
- `file.pdf`, `file(1).pdf`, …, `file(7).pdf`
- `logs/` → `logs/file.log`, `logs/file(1).log`, …, `logs/file(3).log`

### Пример 4 — Кастомный генератор с префиксом и датой

```csharp
_fileSystem = FileSystem.BeginBuilding()
    .AddRandomInTempRootName()
    .AddCustomNameGenerator(info =>
    {
        var dt = DateTime.Now.ToString("yyyyMMdd-HHmmss");
        return $"run-{dt}-{info.Count:D3}{info.Extension}";
    })
    .AddFilesWithNameGeneraing(".xml", 15, "<root/>")
    .Build();
```

Имена будут вида: `run-20260207-143022-000.xml`, `run-20260207-143022-001.xml` и т.д.

## Важные замечания

- Генератор **обязателен** — без вызова `AddNameGenerator` или `AddCustomNameGenerator` методы `WithNameGeneraing` выбросят `InvalidOperationException`.
- Счётчик инкрементируется **после** добавления каждого элемента (файла или директории).
- `RefreshNameGenerator()` сбрасывает `Count` и список `RootFileSystemContent`.
- Стратегии на основе `Path.GetRandomFileName()` дают очень хорошую уникальность без seed.
- Если нужна **полная воспроизводимость** — используйте только `RandomNumber` + фиксированный seed.

Автогенерация имён значительно упрощает создание больших и сложных тестовых структур, делая код чище и избавляя от рутинного именования.
