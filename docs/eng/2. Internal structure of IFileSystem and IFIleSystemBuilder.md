`FileSystem` and `FileSystemBuilder` have a significant number of implementation details that can be useful for creating extensions or for understanding the inner workings.

First, the `IFileSystemBuilder` interface has three methods. One of them is `AddRoot(string root)`, which accepts an absolute path to a **non-existent** directory that will become the root directory for the `IFileSystem` instance. The second method is `Add(string rootRelativePath, Action<string, IFileSystemBuilder> additionalAction)`, where `Action<string, IFileSystemBuilder> additionalAction` represents an action to populate the test file system, which will be called in the `Build` method of `IFileSystemBuilder`. The already mentioned `Build()` method returns an instance of the `IFileSystem` interface.

````csharp
 private readonly IFileSystem _fileSystem = FileSystem.BeginBuilding()
        .AddRoot("MY_TEST_TEMP_FOLDER")
        .AddFile("my-test-file.txt")  // Action deferred until Build method
        .AddFile("my-test-file2.txt", "has content")  // Action deferred until Build method
        .AddFile("my-test-file3.txt", "has content", out var fullPath)  // Action deferred until Build method
        .Build();
````

Note that if an exception occurs during the creation of `FileSystem` elements, to avoid getting a `System.InvalidOperationException` related to the folder already existing, all created content of the root folder and the folder itself will be deleted.

`IFileSystemBuilder` has several extension methods designed to simplify the creation of the root directory.

#### 1) `AddInTempRoot(string root)`
```csharp
public static IFileSystemBuilder AddInTempRoot(this IFileSystemBuilder builder, string root)
```
Creates a root directory with the specified name in the system's temporary folder. The directory will be located at `Path.GetTempPath()/root`.

**Parameters:**
- `builder`: The `IFileSystemBuilder` instance to configure
- `root`: The name of the directory to create in the temp folder

**Returns:** The same `IFileSystemBuilder` instance for method chaining

**Notes:**
- On Windows: the directory is created in `%TEMP%` (typically `C:\Users\<username>\AppData\Local\Temp`)
- On Linux/macOS: the directory is created in `/tmp`
- Directories in the system's temporary folder may be cleaned up by the system or user

**Usage:**
```csharp
var fileSystem = FileSystem.BeginBuilding()
    .AddInTempRoot("my-test-directory")
    .Build();
```

#### 2) `AddInTempRoot(string root, out string fullPath)`
```csharp
public static IFileSystemBuilder AddInTempRoot(this IFileSystemBuilder builder, string root, out string fullPath)
```
Creates a root directory in the system's temporary folder and returns the full path to the created directory.

**Parameters:**
- `builder`: The `IFileSystemBuilder` instance to configure
- `root`: The name of the directory to create in the temp folder
- `fullPath`: Output parameter containing the full path to the created directory

**Returns:** The same `IFileSystemBuilder` instance for method chaining

**Usage:**
```csharp
string rootPath;
var fileSystem = FileSystem.BeginBuilding()
    .AddInTempRoot("test-data", out rootPath)
    .Build();

// On Windows: "C:\Users\Username\AppData\Local\Temp\test-data"
// On Linux: "/tmp/test-data"
```

### `AddRandomRootName` Methods

#### 3) `AddRandomRootName()`
```csharp
public static IFileSystemBuilder AddRandomRootName(this IFileSystemBuilder builder)
```
Creates a root directory with a randomly generated name **in the current working directory**. This means the directory will be created where the test is launched from.

**Parameters:**
- `builder`: The `IFileSystemBuilder` instance to configure

**Returns:** The same `IFileSystemBuilder` instance for method chaining

**Notes:**
- The directory name is generated using `Path.GetRandomFileName()`
- The directory is created relative to the current working directory
- **Does not provide isolation** from other tests in the same folder
- Use when you need to preserve files after the test for debugging

**Usage:**
```csharp
var fileSystem = FileSystem.BeginBuilding()
    .AddRandomRootName()
    .Build();
```

#### 4) `AddRandomRootName(out string rootName)`
```csharp
public static IFileSystemBuilder AddRandomRootName(this IFileSystemBuilder builder, out string rootName)
```
Creates a root directory with a randomly generated name in the current working directory and returns the generated name.

**Parameters:**
- `builder`: The `IFileSystemBuilder` instance to configure
- `rootName`: Output parameter containing the generated random directory name

**Returns:** The same `IFileSystemBuilder` instance for method chaining

**Usage:**
```csharp
string randomName;
var fileSystem = FileSystem.BeginBuilding()
    .AddRandomRootName(out randomName)
    .Build();

// randomName contains a random name, e.g., "xfhnk4j2"
```

### `AddRandomInTempRootName` Methods

#### 5) `AddRandomInTempRootName()`
```csharp
public static IFileSystemBuilder AddRandomInTempRootName(this IFileSystemBuilder builder)
```
Creates a root directory with a randomly generated name **in the system's temporary folder**. This provides better isolation of test data from the main project.

**Parameters:**
- `builder`: The `IFileSystemBuilder` instance to configure

**Returns:** The same `IFileSystemBuilder` instance for method chaining

**Notes:**
- The directory name is generated using `Path.GetRandomFileName()`
- **Provides isolation**: test files are created separately from the project code
- On Windows: the directory is created in `%TEMP%`
- On Linux/macOS: the directory is created in `/tmp`
- Files may be automatically deleted by the system after reboot

**Usage:**
```csharp
var fileSystem = FileSystem.BeginBuilding()
    .AddRandomInTempRootName()
    .Build();
```

#### 6) `AddRandomInTempRootName(out string fullPath)`
```csharp
public static IFileSystemBuilder AddRandomInTempRootName(this IFileSystemBuilder builder, out string fullPath)
```
Creates a root directory with a randomly generated name in the system's temporary folder and returns the full path to the created directory.

**Parameters:**
- `builder`: The `IFileSystemBuilder` instance to configure
- `fullPath`: Output parameter containing the full path to the created directory

**Returns:** The same `IFileSystemBuilder` instance for method chaining

**Usage:**
```csharp
string fullPath;
var fileSystem = FileSystem.BeginBuilding()
    .AddRandomInTempRootName(out fullPath)
    .Build();

// On Windows: "C:\Users\Username\AppData\Local\Temp\xfhnk4j2"
// On Linux: "/tmp/xfhnk4j2"
```

### Example with cleanup:
```csharp
using var fileSystem = FileSystem.BeginBuilding()
    .AddRandomInTempRootName()
    .AddFile("test.txt", "data")
    .Build();

// Tests executed here
// Automatic cleanup on Dispose()
```

In the previous chapter of the documentation, the creation of files and folders in `IFileSystemBuilder` was already discussed. All these extension methods call the `IFileSystemBuilder Add(string rootRelativePath, Action<string, IFileSystemBuilder> additionalAction)` method. This method is used to register `Action<string, IFileSystemBuilder> additionalAction)`, where `string` is the full path to the file and `IFileSystemBuilder` is the builder itself. These `Action` instances are stored in a `HashSet` until the `Build()` method is called, which will execute all of them.

**Example**:

```csharp
public static IFileSystemBuilder AddFile(this IFileSystemBuilder builder, string rootRelativePath)
{
    return builder
        .Add(rootRelativePath, (fullPath, _) => File.Create(fullPath).Dispose());
}
```

You can create your own extension methods that work on the same principle.